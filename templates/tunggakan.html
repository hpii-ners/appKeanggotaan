{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4 animate__animated animate__fadeIn">
    
    <div class="card border-0 shadow-sm p-4 mb-4 no-print" 
         style="background: #ffffff; border-radius: 20px; border-left: 6px solid #dc3545 !important;">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="d-flex align-items-center">
                    <div class="bg-danger-subtle p-2 rounded-3 me-3">
                        <i class="bi bi-person-exclamation text-danger fs-4"></i>
                    </div>
                    <div>
                        <h5 class="mb-0 fw-800">Kontrol Tunggakan</h5>
                        <small class="text-muted">Audit warga belum bayar iuran</small>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <form action="/laporan/tunggakan" method="GET" class="row g-2 justify-content-end">
                    <div class="col-md-3">
                        <select name="bulan" class="form-select form-select-sm border-0 shadow-sm bg-light fw-bold" required>
                            <option value="">-- Pilih Bulan --</option>
                            {% for m in ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'] %}
                            <option value="{{ m }}" {{ 'selected' if bulan_selected == m }}>{{ m }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" name="tahun" class="form-control form-control-sm border-0 shadow-sm bg-light fw-bold text-center" 
                               placeholder="2026" value="{{ tahun_selected or '2026' }}" required>
                    </div>
                    <div class="col-md-3">
                        <select name="zona" class="form-select form-select-sm border-0 shadow-sm bg-light fw-bold">
                            <option value="">-- Semua Zona --</option>
                            {% for z in list_zona %}
                            <option value="{{ z }}" {{ 'selected' if zona_selected == z }}>{{ z }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-auto">
                        <button type="submit" class="btn btn-sm btn-danger px-4 fw-bold shadow-sm">
                            <i class="bi bi-search me-1"></i> ANALISA
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if periode %}
    <div class="card border-0 shadow-lg p-5 mx-auto print-container" style="max-width: 1050px; border-radius: 0; min-height: 29.7cm; background: white;">
        
        <div class="row align-items-center mb-5 pb-4 border-bottom border-2">
            <div class="col-8">
                <h4 class="fw-800 mb-0 text-danger text-uppercase" style="letter-spacing: 1px;">Daftar Tunggakan Iuran</h4>
                <p class="text-muted mb-0">Periode Audit: <span class="fw-bold text-dark">{{ periode }}</span></p>
                {% if zona_selected %}
                <p class="text-muted small mb-0">Zona Wilayah: <span class="fw-bold text-dark">{{ zona_selected }}</span></p>
                {% endif %}
            </div>
            <div class="col-4 text-end">
                <div class="no-print mb-3">
                    <button type="button" onclick="window.print()" class="btn btn-dark fw-bold px-4 shadow">
                        <i class="bi bi-printer me-2"></i> CETAK
                    </button>
                </div>
                <h1 class="display-5 fw-bold text-light d-none d-lg-block" style="letter-spacing: -2px; opacity: 0.5;">UNPAID</h1>
            </div>
        </div>

        <div class="row g-3 mb-5">
            <div class="col-md-4">
                <div class="p-3 bg-light rounded-4 border-start border-danger border-4 shadow-sm">
                    <small class="text-muted d-block text-uppercase fw-bold mb-1" style="font-size: 9px; letter-spacing: 1px;">Total Tunggakan</small>
                    <span class="h3 fw-bold text-danger">{{ data|length }} <small class="fs-6 text-muted">Warga</small></span>
                </div>
            </div>
            <div class="col-md-8">
                <div class="p-3 bg-white border rounded-4 shadow-sm d-flex align-items-center">
                    <i class="bi bi-info-circle-fill text-primary fs-3 me-3"></i>
                    <div>
                        <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 9px;">Keterangan Sistem</small>
                        <p class="mb-0 small text-dark fw-bold">Data ini membandingkan Master Warga dengan Iuran yang tercatat pada bulan {{ bulan_selected }} tahun {{ tahun_selected }}.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table custom-table">
                <thead>
                    <tr>
                        <th class="text-center" style="width: 50px;">NO</th>
                        <th>NAMA WARGA</th>
                        <th>BLOK RUMAH</th>
                        <th>ZONA</th>
                        <th class="text-center">STATUS KEUANGAN</th>
                        <th class="text-end no-print">AKSI PENAGIHAN</th>
                    </tr>
                </thead>
                <tbody>
                    {% for w in data %}
                    <tr>
                        <td class="text-center text-muted small">{{ loop.index }}</td>
                        <td>
                            <div class="fw-bold text-dark">{{ w.nama }}</div>
                            <small class="text-muted d-block d-md-none">Blok {{ w.blok }}</small>
                        </td>
                        <td><span class="badge bg-light text-dark border px-2 py-1">{{ w.blok }}</span></td>
                        <td><span class="text-muted fw-bold">{{ w.zona }}</span></td>
                        <td class="text-center">
                            <span class="badge bg-danger text-white px-3 py-2 rounded-pill fw-bold" style="font-size: 10px;">BELUM LUNAS</span>
                        </td>
                        <td class="text-end no-print">
                            {% set wa_text = "Halo Bapak/Ibu " ~ w.nama ~ ", menginfokan iuran IPL untuk bulan " ~ periode ~ " belum tercatat. Mohon segera melakukan pembayaran. Terima kasih." %}
                            <a href="https://wa.me/{{ w.no_hp|replace(' ', '')|replace('-', '')|replace('08', '628', 1) }}?text={{ wa_text|urlencode }}" 
                               target="_blank" 
                               class="btn btn-sm btn-success rounded-pill px-3 shadow-sm fw-bold">
                                <i class="bi bi-whatsapp me-1"></i> Tagih WA
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not data %}
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="bi bi-check-circle text-success display-4 d-block mb-3"></i>
                            <h5 class="fw-bold">Luar Biasa! Tidak Ada Tunggakan.</h5>
                            <p class="text-muted">Semua warga di zona ini sudah melakukan pembayaran pada periode {{ periode }}.</p>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <div class="row mt-auto pt-5 text-center d-none d-print-flex" style="margin-top: 100px !important;">
            <div class="col-6">
                <p class="mb-5 small text-muted text-uppercase fw-bold" style="letter-spacing: 1px;">Ketua Lingkungan,</p>
                <div class="mx-auto border-bottom border-dark mb-1" style="width: 200px;"></div>
                <p class="fw-bold mb-0 text-dark">{{ identitas.ketua if identitas.ketua else 'Ns. Hendi, S.Kep. MMSI' }}</p>
                <small class="text-muted">NIK/Tanda Tangan</small>
            </div>
            <div class="col-6">
                <p class="mb-5 small text-muted text-uppercase fw-bold" style="letter-spacing: 1px;">Bendahara,</p>
                <div class="mx-auto border-bottom border-dark mb-1" style="width: 200px;"></div>
                <p class="fw-bold mb-0 text-dark">{{ identitas.sekretaris if identitas.sekretaris else '................' }}</p>
                <small class="text-muted">Tanda Tangan</small>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5 mt-5">
        <div class="bg-white shadow-sm d-inline-block p-5 rounded-circle mb-4">
            <i class="bi bi-search display-1 text-danger opacity-25"></i>
        </div>
        <h4 class="fw-800 text-dark">Siap Melakukan Audit?</h4>
        <p class="text-muted mx-auto" style="max-width: 400px;">Silakan pilih bulan, tahun, dan zona wilayah pada bilah merah di atas untuk mendeteksi siapa yang belum membayar iuran.</p>
    </div>
    {% endif %}
</div>

<style>
    .fw-800 { font-weight: 800; }
    .fw-600 { font-weight: 600; }
    
    .custom-table thead th {
        background-color: #f8fafc;
        border-bottom: 3px solid #dc3545;
        color: #1e293b;
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 15px 12px;
    }

    .custom-table tbody td {
        padding: 18px 12px;
        border-bottom: 1px solid #e2e8f0;
        font-size: 14px;
    }

    /* Efek Khusus Print A4 */
    @media print {
        @page { 
            size: A4 portrait; 
            margin: 0; 
        }
        body { 
            background: white !important; 
            visibility: hidden;
        }
        .main-content { margin-left: 0 !important; padding: 0 !important; }
        .print-container, .print-container * {
            visibility: visible;
        }
        .print-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100% !important;
            box-shadow: none !important;
            padding: 1.5cm !important;
        }
        .no-print { display: none !important; }
        .badge { border: 1px solid #000 !important; color: #000 !important; }
        .text-danger { color: #000 !important; }
    }
</style>
{% endblock %}